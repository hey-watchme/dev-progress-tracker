name: Monthly Progress Report to Notion

on:
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to fetch (default: 30)'
        required: false
        default: '30'

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch organization activity (past month)
      id: fetch_activity
      env:
        GH_TOKEN: ${{ github.token }}
        DAYS: ${{ github.event.inputs.days || '30' }}
      run: |
        # Fetch commits from the past N days
        SINCE=$(date -u -d "$DAYS days ago" '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u -v-${DAYS}d '+%Y-%m-%dT%H:%M:%SZ')

        echo "Fetching events since: $SINCE (past $DAYS days)"

        # Get all repositories in the organization
        REPOS=$(gh api /orgs/hey-watchme/repos --paginate --jq '.[].name')

        # Group commits by date
        declare -A COMMITS_BY_DATE
        TOTAL_COMMITS=0

        for repo in $REPOS; do
          echo "Checking repo: $repo"

          # Get commits from the specified period
          COMMITS=$(gh api "/repos/hey-watchme/$repo/commits?since=$SINCE&per_page=100" --paginate --jq '.[] | "\(.commit.author.date)|\(.commit.author.name)|\(.commit.message | split("\n")[0])|\(env.repo)"' 2>/dev/null || echo "")

          if [ -n "$COMMITS" ]; then
            while IFS='|' read -r date author message repo_name; do
              # Extract date (YYYY-MM-DD)
              commit_date=$(echo "$date" | cut -d'T' -f1)

              # Initialize array if not exists
              if [ -z "${COMMITS_BY_DATE[$commit_date]}" ]; then
                COMMITS_BY_DATE[$commit_date]="**${repo_name}**:\n- [${author}] ${message}\n"
              else
                COMMITS_BY_DATE[$commit_date]="${COMMITS_BY_DATE[$commit_date]}- [${author}] ${message}\n"
              fi

              TOTAL_COMMITS=$((TOTAL_COMMITS + 1))
            done <<< "$COMMITS"
          fi
        done

        echo "Total commits found: $TOTAL_COMMITS"
        echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT

        # Save dates for iteration
        echo "${!COMMITS_BY_DATE[@]}" > /tmp/dates.txt

        # Save each date's commits
        for date in "${!COMMITS_BY_DATE[@]}"; do
          echo -e "${COMMITS_BY_DATE[$date]}" > "/tmp/commits_${date}.txt"
        done

    - name: Send to Notion Database
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        # Read dates
        DATES=$(cat /tmp/dates.txt)

        for date in $DATES; do
          echo "Processing date: $date"

          # Read activities for this date
          ACTIVITIES=$(cat "/tmp/commits_${date}.txt" | jq -Rs . | head -c 2000 | jq -Rs .)

          # Count commits for this date
          COMMIT_COUNT=$(cat "/tmp/commits_${date}.txt" | grep -c "^\-" || echo "0")

          # Extract unique repositories
          REPOS=$(cat "/tmp/commits_${date}.txt" | grep -o '\*\*[^*]*\*\*' | sed 's/\*\*//g' | sort -u | jq -R . | jq -s 'map({name: .})')

          # Create Notion page
          curl -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data @- << EOF
          {
            "parent": {
              "database_id": "$NOTION_DATABASE_ID"
            },
            "properties": {
              "Title": {
                "title": [
                  {
                    "text": {
                      "content": "Report $date"
                    }
                  }
                ]
              },
              "Date": {
                "date": {
                  "start": "$date"
                }
              },
              "Commits": {
                "number": $COMMIT_COUNT
              },
              "Activities": {
                "rich_text": [
                  {
                    "text": {
                      "content": $(echo $ACTIVITIES)
                    }
                  }
                ]
              },
              "Repositories": {
                "multi_select": $REPOS
              }
            }
          }
        EOF

          echo "Report for $date sent to Notion successfully!"
          sleep 1  # Rate limiting
        done

        echo "All reports sent to Notion!"
