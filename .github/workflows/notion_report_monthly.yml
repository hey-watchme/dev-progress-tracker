name: Monthly Progress Report to Notion

on:
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to fetch (default: 30)'
        required: false
        default: '30'

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch organization activity (past month)
      id: fetch_activity
      env:
        GH_TOKEN: ${{ github.token }}
        DAYS: ${{ github.event.inputs.days || '30' }}
      run: |
        # Fetch commits from the past N days
        SINCE=$(date -u -d "$DAYS days ago" '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u -v-${DAYS}d '+%Y-%m-%dT%H:%M:%SZ')

        echo "Fetching events since: $SINCE (past $DAYS days)"

        # Get all repositories in the organization
        REPOS=$(gh api /orgs/hey-watchme/repos --paginate --jq '.[].name')

        # Temporary file to store all commits with metadata
        > /tmp/all_commits.txt

        for repo in $REPOS; do
          echo "Checking repo: $repo"

          # Get commits from the specified period
          gh api "/repos/hey-watchme/$repo/commits?since=$SINCE&per_page=100" --paginate \
            --jq ".[] | \"\(.commit.author.date)|\(.commit.author.name)|\(.commit.message | split(\"\\n\")[0] | .[0:100])|${repo}\"" \
            2>/dev/null >> /tmp/all_commits.txt || true
        done

        # Get unique dates
        DATES=$(cat /tmp/all_commits.txt | cut -d'T' -f1 | sort -u)

        echo "Dates found: $DATES"
        echo "$DATES" > /tmp/dates.txt

        # Group commits by date and repository
        for date in $DATES; do
          echo "ðŸ“… Activity Report" > "/tmp/commits_${date}.txt"
          echo "" >> "/tmp/commits_${date}.txt"

          # Get all commits for this date
          grep "^${date}" /tmp/all_commits.txt | while IFS='|' read -r datetime author message repo; do
            echo "${repo}|${author}|${message}"
          done | sort | awk -F'|' '
            BEGIN { current_repo = "" }
            {
              repo = $1
              author = $2
              message = $3

              if (repo != current_repo) {
                if (current_repo != "") {
                  print ""
                }
                current_repo = repo
                count[repo]++
                print "ðŸ“¦ " repo
              }
              print "  â€¢ [" author "] " message
            }
            END {
              for (r in count) {
                total += count[r]
              }
            }
          ' >> "/tmp/commits_${date}.txt"

          # Count commits for this date
          COMMIT_COUNT=$(grep "^${date}" /tmp/all_commits.txt | wc -l | xargs)
          echo "$COMMIT_COUNT" > "/tmp/count_${date}.txt"

          # Get unique repos for this date
          grep "^${date}" /tmp/all_commits.txt | cut -d'|' -f4 | sort -u > "/tmp/repos_${date}.txt"
        done

    - name: Send to Notion Database
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        # Read dates
        DATES=$(cat /tmp/dates.txt)

        for date in $DATES; do
          echo "Processing date: $date"

          # Read activities for this date
          ACTIVITIES=$(cat "/tmp/commits_${date}.txt" | jq -Rs . | head -c 2000 | jq -Rs .)

          # Count commits for this date
          COMMIT_COUNT=$(cat "/tmp/count_${date}.txt")

          # Extract unique repositories
          REPOS=$(cat "/tmp/repos_${date}.txt" | jq -R . | jq -s 'map({name: .})')

          # Create Notion page
          curl -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data @- << EOF
          {
            "parent": {
              "database_id": "$NOTION_DATABASE_ID"
            },
            "properties": {
              "Title": {
                "title": [
                  {
                    "text": {
                      "content": "Report $date"
                    }
                  }
                ]
              },
              "Date": {
                "date": {
                  "start": "$date"
                }
              },
              "Commits": {
                "number": $COMMIT_COUNT
              },
              "Activities": {
                "rich_text": [
                  {
                    "text": {
                      "content": $(echo $ACTIVITIES)
                    }
                  }
                ]
              },
              "Repositories": {
                "multi_select": $REPOS
              }
            }
          }
        EOF

          echo "Report for $date sent to Notion successfully!"
          sleep 1
        done

        echo "All reports sent to Notion!"
