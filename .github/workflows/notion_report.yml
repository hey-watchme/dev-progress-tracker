name: Daily Progress Report to Notion

on:
  schedule:
    - cron: "0 13 * * *"  # JST 22:00 (UTC 13:00)
  workflow_dispatch: {}   # Manual execution

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch organization activity
      id: fetch_activity
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Fetch recent events from hey-watchme organization
        SINCE=$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u -v-24H '+%Y-%m-%dT%H:%M:%SZ')

        echo "Fetching events since: $SINCE"

        # Get all repositories in the organization
        REPOS=$(gh api /orgs/hey-watchme/repos --paginate --jq '.[].name')

        TOTAL_COMMITS=0
        ACTIVITIES=""
        ACTIVE_REPOS=""

        for repo in $REPOS; do
          echo "Checking repo: $repo"

          # Get commits from the last 24 hours with rich formatting
          COMMITS=$(gh api "/repos/hey-watchme/$repo/commits?since=$SINCE" --jq '.[] | "  â€¢ [\(.commit.author.name)] \(.commit.message | split("\n")[0] | .[0:100])"' 2>/dev/null || echo "")

          if [ -n "$COMMITS" ]; then
            COMMIT_COUNT=$(echo "$COMMITS" | wc -l | xargs)
            TOTAL_COMMITS=$((TOTAL_COMMITS + COMMIT_COUNT))

            # Rich format with emoji and better structure
            ACTIVITIES="${ACTIVITIES}ðŸ“¦ ${repo} (${COMMIT_COUNT} commits)\n${COMMITS}\n\n"

            if [ -z "$ACTIVE_REPOS" ]; then
              ACTIVE_REPOS="$repo"
            else
              ACTIVE_REPOS="${ACTIVE_REPOS}, ${repo}"
            fi
          fi
        done

        # If no activity, set default message
        if [ $TOTAL_COMMITS -eq 0 ]; then
          ACTIVITIES="ðŸ“­ No commits in the last 24 hours"
          ACTIVE_REPOS="None"
        else
          # Add header with date
          ACTIVITIES="ðŸ“… Activity Report\n\n${ACTIVITIES}"
        fi

        # Save to output (escape newlines for GitHub Actions)
        echo "commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
        echo "active_repos=$ACTIVE_REPOS" >> $GITHUB_OUTPUT

        # Save activities to a file to avoid issues with special characters
        echo -e "$ACTIVITIES" > /tmp/activities.txt

    - name: Send to Notion Database
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        NOW=$(date +'%Y-%m-%d')
        COMMITS="${{ steps.fetch_activity.outputs.commits }}"
        ACTIVE_REPOS="${{ steps.fetch_activity.outputs.active_repos }}"

        # Create Notion page (without Activities property)
        PAGE_RESPONSE=$(curl -s -X POST "https://api.notion.com/v1/pages" \
          -H "Authorization: Bearer $NOTION_TOKEN" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data @- << EOF
        {
          "parent": {
            "database_id": "$NOTION_DATABASE_ID"
          },
          "properties": {
            "Title": {
              "title": [
                {
                  "text": {
                    "content": "Report $NOW"
                  }
                }
              ]
            },
            "Date": {
              "date": {
                "start": "$NOW"
              }
            },
            "Commits": {
              "number": $COMMITS
            },
            "Repositories": {
              "multi_select": $(echo "$ACTIVE_REPOS" | jq -R 'split(", ") | map({name: .})')
            }
          }
        }
        EOF
        )

        # Extract page ID
        PAGE_ID=$(echo "$PAGE_RESPONSE" | jq -r '.id')
        echo "Created page: $PAGE_ID"

        # Build children blocks from activities
        python3 << 'PYTHON_EOF'
        import json
        import sys

        # Read activities from file
        with open('/tmp/activities.txt', 'r') as f:
            activities = f.read()

        children = []

        # Add header
        children.append({
            "object": "block",
            "type": "heading_2",
            "heading_2": {
                "rich_text": [{
                    "type": "text",
                    "text": {"content": "ðŸ“… Activity Report"}
                }]
            }
        })

        # Parse activities line by line
        for line in activities.split('\n'):
            line = line.strip()
            if not line or line == "ðŸ“… Activity Report":
                continue

            # Repository heading (starts with ðŸ“¦)
            if line.startswith('ðŸ“¦'):
                children.append({
                    "object": "block",
                    "type": "heading_3",
                    "heading_3": {
                        "rich_text": [{
                            "type": "text",
                            "text": {"content": line}
                        }]
                    }
                })
            # Commit item (starts with â€¢)
            elif line.startswith('â€¢'):
                children.append({
                    "object": "block",
                    "type": "bulleted_list_item",
                    "bulleted_list_item": {
                        "rich_text": [{
                            "type": "text",
                            "text": {"content": line[2:].strip()}  # Remove â€¢ prefix
                        }]
                    }
                })
            # No commits message
            elif 'ðŸ“­' in line:
                children.append({
                    "object": "block",
                    "type": "paragraph",
                    "paragraph": {
                        "rich_text": [{
                            "type": "text",
                            "text": {"content": line}
                        }]
                    }
                })

        # Write to JSON file
        with open('/tmp/children.json', 'w') as f:
            json.dump({"children": children}, f, ensure_ascii=False, indent=2)

        PYTHON_EOF

        # Append blocks to the page
        curl -X PATCH "https://api.notion.com/v1/blocks/$PAGE_ID/children" \
          -H "Authorization: Bearer $NOTION_TOKEN" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          -d @/tmp/children.json

        echo "Report sent to Notion successfully!"
